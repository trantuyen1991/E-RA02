<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartHome 2D - iFrame</title>
  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <div class="menu-container active" id="menu">
    <!-- Piechart -->  
    <div id="id_PieChart_01" ></div>
    <div id="id_PieChart_02" ></div>
    <!-- Line Chart -->
    <div id="id_LineChart_01"></div>
    <!-- Column Chart -->
    <div id="id_ColumnChart_01"></div>
  </div>
  <!-- Piechart -->  
  <script type="text/javascript">
    google.charts.load("current", { packages: ["corechart"] });
    google.charts.setOnLoadCallback(drawInitialChart);
    // Define data and chart globally
    let data_PieChart_01,chart_PieChart_01,
        data_PieChart_02,chart_PieChart_02;
    let data_LineChart_01, chart_LineChart_01; 
    let data_ColumnChart_01,chart_ColumnChart_01,view_ColumnChart_01;
    // Style setting
    const options_PieChart_01 = {
      //width: 500,
      //height: 200,
      title: 'CV103-Daily Product',
      is3D: true,
      backgroundColor:'transparent'
      //pieHole: 0.4
    };
    // Style setting
    const options_PieChart_02 = {
      //width: 500,
      //height: 200,
      title: 'CV103-Daily Product',
      is3D: true,
      backgroundColor:'transparent'
      //pieHole: 0.4
    };
    // Line Chart   
    const options_LineChart_01 = {
      title: 'Pail Per Min',
      curveType: 'function',
      legend: { position: 'bottom', maxLines: 2 }
    }; 
    // Column Chart               
    const options_ColumnChart_01 = {
      title: "Daily Total Product",
      bar: {groupWidth: "65%"},
      legend: { position: "bottom", maxLines: 2 },
      isStacked: true,
      colors: ['#9FE2BF', '#FF7F50', '#6495ED', '#DE3163','#008080'],
      vAxis: {
        title: 'Total'
      }
    };    
    // Initialize the Line Chart
    function drawInitialChart() {
      /*-----------------------------Pie Chart Initialization (Unchanged)-----------------------------*/
      data_PieChart_01 = google.visualization.arrayToDataTable([
        ['Task', 'Value'],
        ['Temperature', 0],
        ['Humidity', 0],
        ['Power', 0]
      ]);
      chart_PieChart_01 = new google.visualization.PieChart(document.getElementById('id_PieChart_01'));
      chart_PieChart_01.draw(data_PieChart_01, options_PieChart_01);

      data_PieChart_02 = google.visualization.arrayToDataTable([
        ['Task', 'Value'],
        ['Temperature', 0],
        ['Humidity', 0],
        ['Power', 0]
      ]);
      chart_PieChart_02 = new google.visualization.PieChart(document.getElementById('id_PieChart_02'));
      chart_PieChart_02.draw(data_PieChart_02, options_PieChart_02);

      /*-----------------------------Line Chart Initialization-----------------------------*/
      // Data
      data_LineChart_01 = google.visualization.arrayToDataTable([
        ['Time', 'CV103', 'CV104', 'CV105', 'CV106', 'CV107'],
        [formatTime(new Date()), 0, 1,2,3,4]
      ]);
      // Draw  
      chart_LineChart_01 = new google.visualization.LineChart(document.getElementById('id_LineChart_01'));
      chart_LineChart_01.draw(data_LineChart_01, options_LineChart_01);
      /*-----------------------------Column Chart------------------------------------*/
      // Data
      data_ColumnChart_01 = google.visualization.arrayToDataTable([
          ['Station','Tint/Dalmec', '275mm/30Pail', '370mm/30Pail', '370mm/26Pail', '380mm/30Pail',
           { role: 'annotation' } ],
          ['CV103', 10, 24, 20, 32, 18,''],
          ['CV104', 16, 22, 23, 30, 16,''],
          ['CV105', 28, 19, 29, 30, 12,''],
          ['CV106', 28, 19, 29, 30, 12,''],
          ['CV107', 28, 19, 29, 30, 12,'']
          
      ]);
      // View
      view_ColumnChart_01 = new google.visualization.DataView(data_ColumnChart_01);
      view_ColumnChart_01.setColumns([0,1,2,3,4,5,
                          {   calc: "stringify",
                              sourceColumn: 6,
                              type: "string",
                              role: "annotation"
                          }
      ]);
      
      // Draw
      chart_ColumnChart_01 = new google.visualization.ColumnChart(document.getElementById("id_ColumnChart_01"));
      chart_ColumnChart_01.draw(view_ColumnChart_01, options_ColumnChart_01);
    }
/*-----------------------------FUNCTION- Update Line Chart------------------------------------*/
    function appendData_LineChart_01(CV103, CV104, CV105, CV106, CV107) {
      const now = new Date();
      const newRow = [
        formatTime(now), // Use formatted current time
        CV103, CV104, CV105, CV106, CV107 // Manual Pail Rate input
      ];
      data_LineChart_01.addRow(newRow);

      // Limit rows in the chart to maxRows
      const maxRows = 1000;
      while (data_LineChart_01.getNumberOfRows() > maxRows) {
        data_LineChart_01.removeRow(0);
      }
      // Redraw the chart with the updated data
      chart_LineChart_01.draw(data_LineChart_01, options_LineChart_01);
    }
  /*-----------------------------FUNCTION- Update Pie Chart------------------------------------*/
    function update_PieChart_01(CV103, CV104, CV105) {
      data_PieChart_01.setValue(0, 1, CV103); // 
      data_PieChart_01.setValue(1, 1, CV104); // 
      data_PieChart_01.setValue(2, 1, CV105); // 
      chart_PieChart_01.draw(data_PieChart_01, options_PieChart_01); // Redraw the chart with updated data
      chart_PieChart_02.draw(data_PieChart_01, options_PieChart_02); // Redraw the chart with updated data
    }
  /*-----------------------------FUNCTION- Update Pie Chart------------------------------------*/
    function update_ColumnChart_01( CV103_Tint, CV103_275, CV103_370, CV103_375, CV103_380,
                                    CV104_Tint, CV104_275, CV104_370, CV104_375, CV104_380,
                                    CV105_Tint, CV105_275, CV105_370, CV105_375, CV105_380,
                                    CV106_Tint, CV106_275, CV106_370, CV106_375, CV106_380,
                                    CV107_Tint, CV107_275, CV107_370, CV107_375, CV107_380) {
      data_ColumnChart_01.setValue(0, 1, CV103_Tint); data_ColumnChart_01.setValue(0, 2, CV103_275);data_ColumnChart_01.setValue(0, 3, CV103_370);data_ColumnChart_01.setValue(0, 4, CV103_375);data_ColumnChart_01.setValue(0, 5, CV103_380);  
      data_ColumnChart_01.setValue(1, 1, CV104_Tint); data_ColumnChart_01.setValue(1, 2, CV104_275);data_ColumnChart_01.setValue(1, 3, CV104_370);data_ColumnChart_01.setValue(1, 4, CV104_375);data_ColumnChart_01.setValue(1, 5, CV104_380);  
      data_ColumnChart_01.setValue(2, 1, CV105_Tint); data_ColumnChart_01.setValue(2, 2, CV105_275);data_ColumnChart_01.setValue(2, 3, CV105_370);data_ColumnChart_01.setValue(2, 4, CV105_375);data_ColumnChart_01.setValue(2, 5, CV105_380);  
      data_ColumnChart_01.setValue(3, 1, CV106_Tint); data_ColumnChart_01.setValue(3, 2, CV106_275);data_ColumnChart_01.setValue(3, 3, CV106_370);data_ColumnChart_01.setValue(3, 4, CV106_375);data_ColumnChart_01.setValue(3, 5, CV106_380);  
      data_ColumnChart_01.setValue(4, 1, CV107_Tint); data_ColumnChart_01.setValue(4, 2, CV107_275);data_ColumnChart_01.setValue(4, 3, CV107_370);data_ColumnChart_01.setValue(4, 4, CV107_375);data_ColumnChart_01.setValue(4, 5, CV107_380);     
      chart_ColumnChart_01.draw(data_ColumnChart_01, options_ColumnChart_01); // Redraw the chart with updated data
    }
/*-----------------------------Utility Function------------------------------------*/
    // Function to format the current time as HH:MM:SS
    function formatTime(date) {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const seconds = date.getSeconds().toString().padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }
  </script> 
    <!--------------------------------- GET DATA FROM ERA ---------------------------->   
    <script>
      const eraWidget = new EraWidget();
      // Khai báo các tag sử dụng    
      let C3_nFb_PailType   = null,
          C4_nFb_PailType   = null,
          C5_nFb_PailType   = null,
          C6_nFb_PailType   = null,
          C7_nFb_PailType   = null;
      // Pail Rate   
      let C3_nFb_PailRate   = null,
          C4_nFb_PailRate   = null,
          C5_nFb_PailRate   = null,
          C6_nFb_PailRate   = null,
          C7_nFb_PailRate   = null;
      // Total Pail
      let C3_nFb_Total_Tint   = null,
          C3_nFb_Total_275    = null,
          C3_nFb_Total_370    = null,
          C3_nFb_Total_375    = null,
          C3_nFb_Total_380    = null;
      //
      let C4_nFb_Total_Tint   = null,
          C4_nFb_Total_275    = null,
          C4_nFb_Total_370    = null,
          C4_nFb_Total_375    = null,
          C4_nFb_Total_380    = null;
      //
      let C5_nFb_Total_Tint   = null,
          C5_nFb_Total_275    = null,
          C5_nFb_Total_370    = null,
          C5_nFb_Total_375    = null,
          C5_nFb_Total_380    = null;
      //
      let C6_nFb_Total_Tint   = null,
          C6_nFb_Total_275    = null,
          C6_nFb_Total_370    = null,
          C6_nFb_Total_375    = null,
          C6_nFb_Total_380    = null;
      //
      let C7_nFb_Total_Tint   = null,
          C7_nFb_Total_275    = null,
          C7_nFb_Total_370    = null,
          C7_nFb_Total_375    = null,
          C7_nFb_Total_380    = null;
      //
      const maxRows = 1000; // Limit the number of rows in the data table    
      eraWidget.init({
        // Lưu các cấu hình khi nhận được từ widget
        onConfiguration: (configuration) => {
          // Pail Type
          C3_nFb_PailType = configuration.realtime_configs[0]; // 
          C4_nFb_PailType = configuration.realtime_configs[1]; // 
          C5_nFb_PailType = configuration.realtime_configs[2]; // 
          C6_nFb_PailType = configuration.realtime_configs[3]; // 
          C7_nFb_PailType = configuration.realtime_configs[4]; // 
          // Pail Rate
          C3_nFb_PailRate = configuration.realtime_configs[5]; // 
          C4_nFb_PailRate = configuration.realtime_configs[6]; // 
          C5_nFb_PailRate = configuration.realtime_configs[7]; // 
          C6_nFb_PailRate = configuration.realtime_configs[8]; // 
          C7_nFb_PailRate = configuration.realtime_configs[9]; // 
          // Total Pail
          C3_nFb_Total_Tint = configuration.realtime_configs[10]; // 
          C3_nFb_Total_275  = configuration.realtime_configs[11]; // 
          C3_nFb_Total_370  = configuration.realtime_configs[12]; // 
          C3_nFb_Total_375  = configuration.realtime_configs[13]; // 
          C3_nFb_Total_380  = configuration.realtime_configs[14]; // 
          // Total Pail
          C4_nFb_Total_Tint = configuration.realtime_configs[15]; // 
          C4_nFb_Total_275  = configuration.realtime_configs[16]; // 
          C4_nFb_Total_370  = configuration.realtime_configs[17]; // 
          C4_nFb_Total_375  = configuration.realtime_configs[18]; // 
          C4_nFb_Total_380  = configuration.realtime_configs[19]; // 
          // Total Pail
          C5_nFb_Total_Tint = configuration.realtime_configs[20]; // 
          C5_nFb_Total_275  = configuration.realtime_configs[21]; // 
          C5_nFb_Total_370  = configuration.realtime_configs[22]; // 
          C5_nFb_Total_375  = configuration.realtime_configs[23]; // 
          C5_nFb_Total_380  = configuration.realtime_configs[24]; //
          // Total Pail
          C6_nFb_Total_Tint = configuration.realtime_configs[25]; // 
          C6_nFb_Total_275  = configuration.realtime_configs[26]; // 
          C6_nFb_Total_370  = configuration.realtime_configs[27]; // 
          C6_nFb_Total_375  = configuration.realtime_configs[28]; // 
          C6_nFb_Total_380  = configuration.realtime_configs[29]; //  
          // Total Pail
          C7_nFb_Total_Tint = configuration.realtime_configs[30]; // 
          C7_nFb_Total_275  = configuration.realtime_configs[31]; // 
          C7_nFb_Total_370  = configuration.realtime_configs[32]; // 
          C7_nFb_Total_375  = configuration.realtime_configs[33]; // 
          C7_nFb_Total_380  = configuration.realtime_configs[34]; //  
        },
        // Update the chart with new values
        onValues: (values) => {
          //
          appendData_LineChart_01(  values[C3_nFb_PailRate.id].value,
                                    values[C4_nFb_PailRate.id].value, 
                                    values[C5_nFb_PailRate.id].value, 
                                    values[C6_nFb_PailRate.id].value, 
                                    values[C7_nFb_PailRate.id].value);
          // Update the chart with new values
          update_PieChart_01( values[C3_nFb_PailType.id].value,
                              values[C4_nFb_PailType.id].value, 
                              values[C5_nFb_PailType.id].value);
          //
          update_ColumnChart_01(values[C3_nFb_Total_Tint.id].value, values[C3_nFb_Total_275.id].value,values[C3_nFb_Total_370.id].value,values[C3_nFb_Total_375.id].value, values[C3_nFb_Total_380.id].value,
                                values[C4_nFb_Total_Tint.id].value, values[C4_nFb_Total_275.id].value,values[C4_nFb_Total_370.id].value,values[C4_nFb_Total_375.id].value, values[C4_nFb_Total_380.id].value,
                                values[C5_nFb_Total_Tint.id].value, values[C5_nFb_Total_275.id].value,values[C5_nFb_Total_370.id].value,values[C5_nFb_Total_375.id].value, values[C5_nFb_Total_380.id].value,
                                values[C6_nFb_Total_Tint.id].value, values[C6_nFb_Total_275.id].value,values[C6_nFb_Total_370.id].value,values[C6_nFb_Total_375.id].value, values[C6_nFb_Total_380.id].value,
                                values[C7_nFb_Total_Tint.id].value, values[C7_nFb_Total_275.id].value,values[C7_nFb_Total_370.id].value,values[C7_nFb_Total_375.id].value, values[C7_nFb_Total_380.id].value
          );
          
        },
      });
    </script>
</body>
</html>