<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartHome 2D - iFrame</title>
  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <div class="menu-container active" id="menu">
    <!-- Piechart -->  
    <div id="id_PieChart_01" ></div>
    <div id="id_PieChart_02" ></div>
    <!-- Line Chart -->
    <div id="id_LineChart_01"></div>
    <!-- Column Chart -->
    <div id="id_ColumnChart_01"></div>
  </div>
  <!-- Piechart -->  
  <script type="text/javascript">
    google.charts.load("current", { packages: ["corechart"] });
    google.charts.setOnLoadCallback(drawInitialChart);
    // Define data and chart globally
    let data_PieChart_01,chart_PieChart_01,
        data_PieChart_02,chart_PieChart_02;
    let data_LineChart_01, chart_LineChart_01; 
    let data_ColumnChart_01,chart_ColumnChart_01,view_ColumnChart_01;
    // Style setting
    const options_PieChart_01 = {
      //width: 500,
      //height: 200,
      title: 'CV103-Daily Product',
      is3D: true,
      backgroundColor:'transparent'
      //pieHole: 0.4
    };
    // Style setting
    const options_PieChart_02 = {
      //width: 500,
      //height: 200,
      title: 'CV103-Daily Product',
      is3D: true,
      backgroundColor:'transparent'
      //pieHole: 0.4
    };
    // Line Chart   
    const options_LineChart_01 = {
      title: 'Product Active & Output Rate',
      curveType: 'function',
      legend: { position: 'bottom', maxLines: 2 }
    }; 
    // Column Chart               
    const options_ColumnChart_01 = {
      title: "Daily Total Product",
      width: 600,
      height: 400,
      bar: {groupWidth: "65%"},
      legend: { position: "right", maxLines: 1 },
      isStacked: true,
      colors: ['#ff9999', '#66b3ff', '#99ff99', '#ffcc99','#99ff99'],
      hAxis: {
        title: 'Station'
      },
      vAxis: {
        title: 'Total'
      }
    };    
    // Initialize the Line Chart
    function drawInitialChart() {
      /*-----------------------------Pie Chart Initialization (Unchanged)-----------------------------*/
      data_PieChart_01 = google.visualization.arrayToDataTable([
        ['Task', 'Value'],
        ['Temperature', 0],
        ['Humidity', 0],
        ['Power', 0]
      ]);
      chart_PieChart_01 = new google.visualization.PieChart(document.getElementById('id_PieChart_01'));
      chart_PieChart_01.draw(data_PieChart_01, options_PieChart_01);

      data_PieChart_02 = google.visualization.arrayToDataTable([
        ['Task', 'Value'],
        ['Temperature', 0],
        ['Humidity', 0],
        ['Power', 0]
      ]);
      chart_PieChart_02 = new google.visualization.PieChart(document.getElementById('id_PieChart_02'));
      chart_PieChart_02.draw(data_PieChart_02, options_PieChart_02);

      /*-----------------------------Line Chart Initialization-----------------------------*/
      // Data
      data_LineChart_01 = google.visualization.arrayToDataTable([
        ['Time', 'CV103', 'CV104', 'CV105', 'CV106', 'CV107'],
        [formatTime(new Date()), 0, 1,2,3,4]
      ]);
      // Draw  
      chart_LineChart_01 = new google.visualization.LineChart(document.getElementById('id_LineChart_01'));
      chart_LineChart_01.draw(data_LineChart_01, options_LineChart_01);
      /*-----------------------------Column Chart------------------------------------*/
      // Data
      data_ColumnChart_01 = google.visualization.arrayToDataTable([
          ['Station', '275mm/30Pail', '370mm/30Pail', '370mm/26Pail', '380mm/30Pail',
          'Tint/Dalmec','Total', { role: 'annotation' } ],
          ['CV103', 10, 24, 20, 32, 18, 5, ''],
          ['CV104', 16, 22, 23, 30, 16, 9, ''],
          ['CV105', 28, 19, 29, 30, 12, 13, ''],
          ['CV106', 28, 19, 29, 30, 12, 13, ''],
          ['CV107', 28, 19, 29, 30, 12, 13, '']
          
      ]);
      // View
      view_ColumnChart_01 = new google.visualization.DataView(data_ColumnChart_01);
      view_ColumnChart_01.setColumns([0,1,2,3,4,5,
                          {   calc: "stringify",
                              sourceColumn: 6,
                              type: "string",
                              role: "annotation"
                          }
      ]);
      
      // Draw
      chart_ColumnChart_01 = new google.visualization.ColumnChart(document.getElementById("id_ColumnChart_01"));
      chart_ColumnChart_01.draw(view_ColumnChart_01, options_ColumnChart_01);
    }
/*-----------------------------FUNCTION- Update Line Chart------------------------------------*/
    function appendData_LineChart_01(CV103, CV104, CV105, CV106, CV107) {
      const now = new Date();
      const newRow = [
        formatTime(now), // Use formatted current time
        CV103, CV104, CV105, CV106, CV107 // Manual Pail Rate input
      ];
      data_LineChart_01.addRow(newRow);

      // Limit rows in the chart to maxRows
      const maxRows = 1000;
      while (data_LineChart_01.getNumberOfRows() > maxRows) {
        data_LineChart_01.removeRow(0);
      }
      // Redraw the chart with the updated data
      chart_LineChart_01.draw(data_LineChart_01, options_LineChart_01);
    }
    // Function to update chart data dynamically
    function update_PieChart_01(CV103, CV104, CV105) {
      data_PieChart_01.setValue(0, 1, CV103); // 
      data_PieChart_01.setValue(1, 1, CV104); // 
      data_PieChart_01.setValue(2, 1, CV105); // 
      chart_PieChart_01.draw(data_PieChart_01, options_PieChart_01); // Redraw the chart with updated data
      chart_PieChart_02.draw(data_PieChart_01, options_PieChart_02); // Redraw the chart with updated data
    }
/*-----------------------------Utility Function------------------------------------*/
    // Function to format the current time as HH:MM:SS
    function formatTime(date) {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const seconds = date.getSeconds().toString().padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }
  </script> 
    <!--------------------------------- GET DATA FROM ERA ---------------------------->
    
    <script>
      const eraWidget = new EraWidget();
      // Khai báo các tag sử dụng    
      let C3_nFb_PailType   = null,
          C4_nFb_PailType   = null,
          C5_nFb_PailType   = null,
          C6_nFb_PailType   = null,
          C7_nFb_PailType   = null;
      //    
      let C3_nFb_PailRate   = null,
          C4_nFb_PailRate   = null,
          C5_nFb_PailRate   = null,
          C6_nFb_PailRate   = null,
          C7_nFb_PailRate   = null;
      //
      const maxRows = 1000; // Limit the number of rows in the data table    
      eraWidget.init({
        onConfiguration: (configuration) => {
          // Lưu các cấu hình khi nhận được từ widget
          C3_nFb_PailType = configuration.realtime_configs[0]; // 
          C4_nFb_PailType = configuration.realtime_configs[1]; // 
          C5_nFb_PailType = configuration.realtime_configs[2]; // 
          C6_nFb_PailType = configuration.realtime_configs[3]; // 
          C7_nFb_PailType = configuration.realtime_configs[4]; // 
          //
          C3_nFb_PailRate = configuration.realtime_configs[5]; // 
          C4_nFb_PailRate = configuration.realtime_configs[6]; // 
          C5_nFb_PailRate = configuration.realtime_configs[7]; // 
          C6_nFb_PailRate = configuration.realtime_configs[8]; // 
          C7_nFb_PailRate = configuration.realtime_configs[9]; // 
        },
        // Update the chart with new values
        onValues: (values) => {
          //
          appendData_LineChart_01(  values[C3_nFb_PailType.id].value,
                                    values[C4_nFb_PailType.id].value, 
                                    values[C5_nFb_PailType.id].value, 
                                    values[C6_nFb_PailType.id].value, 
                                    values[C7_nFb_PailType.id].value);
          // Update the chart with new values
          update_PieChart_01( values[C3_nFb_PailType.id].value,
                              values[C4_nFb_PailType.id].value, 
                              values[C5_nFb_PailType.id].value);
          
        },
      });
    </script>
</body>
</html>